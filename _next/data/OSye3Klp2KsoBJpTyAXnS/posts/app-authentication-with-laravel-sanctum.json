{"pageProps":{"post":{"title":"App Authentication with Laravel Sanctum","date":"2020-01-11T19:51:00.322Z","tags":["swift","laravel"],"slug":"app-authentication-with-laravel-sanctum","author":{"name":"Jille van der Weerd","picture":"/assets/blog/authors/jj.jpeg"},"content":"<p>I often use Laravel to build the API that support the apps I build, because I can quickly create something that just works without writing too much code. However, dealing with authentication has (in my opinion) always been a cumbersome task.</p>\n<p>So it doesn’t come as a surprise that after seeing <a href=\"https://twitter.com/taylorotwell/status/1215022507478138882?s=20\">Taylor Otwell’s Tweet about Laravel Sanctum</a> (previously Laravel Airlock) I wanted to give this a try for authentication in a simple mobile application.</p>\n<p>A quick introduction: Sanctum is a package for Laravel. It’s supposed to be a featherweight alternative to existing authentication methods (like Laravel Passport) for use in SPAs and simple APIs.</p>\n<p>I’m going to briefly walk you through installing Sanctum, but if you run into any problems, please refer to the <a href=\"https://github.com/laravel/sanctum\">documentation</a>. After installing Sanctum and building a simple authentication system with it, I’ll show you how to use it in your iOS app. I’ll assume you have basic Swift knowledge, and I won’t go in depth on creating the interface I’ll show in my screenshots.</p>\n<h2>Installation</h2>\n<p>I created a new Laravel project to test this. I’ll assume you know how to do this, but for more information please refer to the <a href=\"https://laravel.com/docs/8.x\">Laravel documentation</a>. cd into the project directory and execute the following commands in your terminal:</p>\n<pre><code class=\"hljs language-bash\">composer require laravel/sanctum\nphp artisan vendor:publish\nphp artisan migrate</code></pre>\n<p>We’re now ready to dive into the Laravel project to finalise setting up Sanctum.</p>\n<p>In your <code>User</code> model, use the <code>HasApiTokens</code> trait as follows:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-keyword\">use</span> <span class=\"hljs-title\">Laravel</span>\\<span class=\"hljs-title\">Sanctum</span>\\<span class=\"hljs-title\">HasApiTokens</span>;\n<span class=\"hljs-comment\">// Other imports omitted.</span>\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">User</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Authenticatable</span>\n</span>{\n    <span class=\"hljs-keyword\">use</span> <span class=\"hljs-title\">HasApiTokens</span>, <span class=\"hljs-title\">Notifiable</span>;\n    <span class=\"hljs-comment\">// Class body omitted.</span>\n}</code></pre>\n<h2>Routes</h2>\n<p>Now that we’ve finished setting up, let’s create some routes. Add the following routes to your <code>routes/api.php</code> file:</p>\n<pre><code class=\"hljs language-php\">Route::prefix(<span class=\"hljs-string\">'sanctum'</span>)->namespace(<span class=\"hljs-string\">'API'</span>)->group(<span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>) </span>{\n    Route::post(<span class=\"hljs-string\">'register'</span>, <span class=\"hljs-string\">'AuthController@register'</span>);\n    Route::post(<span class=\"hljs-string\">'token'</span>, <span class=\"hljs-string\">'AuthController@token'</span>);\n});</code></pre>\n<p>The user will use these two routes to register an account and to request their token (basically, to log in). Let’s create the <code>AuthController</code> and write the implementation of these routes. Run the following line in your terminal:</p>\n<pre><code class=\"hljs language-bash\">php artisan make:controller API\\AuthController</code></pre>\n<p>Open the <code>app/Http/Controllers/API/AuthController.php</code> file you just created and add the <code>register</code> function:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">register</span>(<span class=\"hljs-params\">Request <span class=\"hljs-variable\">$request</span></span>)\n</span>{ \n    <span class=\"hljs-comment\">// 1 </span>\n    <span class=\"hljs-variable\">$validator</span> = Validator::make(<span class=\"hljs-variable\">$request</span>->all(), [\n        <span class=\"hljs-string\">'name'</span> => [<span class=\"hljs-string\">'required'</span>, <span class=\"hljs-string\">'string'</span>, <span class=\"hljs-string\">'max:255'</span>],\n        <span class=\"hljs-string\">'email'</span> => [<span class=\"hljs-string\">'required'</span>, <span class=\"hljs-string\">'string'</span>, <span class=\"hljs-string\">'email'</span>, <span class=\"hljs-string\">'max:255'</span>, <span class=\"hljs-string\">'unique:users'</span>],\n        <span class=\"hljs-string\">'password'</span> => [<span class=\"hljs-string\">'required'</span>, <span class=\"hljs-string\">'string'</span>, <span class=\"hljs-string\">'min:8'</span>],\n        <span class=\"hljs-string\">'device_name'</span> => [<span class=\"hljs-string\">'required'</span>, <span class=\"hljs-string\">'string'</span>]\n    ]); \n\n    <span class=\"hljs-comment\">// 2</span>\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable\">$validator</span>->fails()) {\n        <span class=\"hljs-keyword\">return</span> response()->json([<span class=\"hljs-string\">'error'</span> => <span class=\"hljs-variable\">$validator</span>->errors()], <span class=\"hljs-number\">422</span>);\n    }\n\n    <span class=\"hljs-comment\">// 3</span>\n    <span class=\"hljs-variable\">$input</span> = <span class=\"hljs-variable\">$request</span>->all();\n    <span class=\"hljs-variable\">$input</span>[<span class=\"hljs-string\">'password'</span>] = bcrypt(<span class=\"hljs-variable\">$input</span>[<span class=\"hljs-string\">'password'</span>]);\n    <span class=\"hljs-variable\">$user</span> = User::create(<span class=\"hljs-variable\">$input</span>);\n\n    <span class=\"hljs-comment\">// 4</span>\n    <span class=\"hljs-variable\">$token</span> = <span class=\"hljs-variable\">$user</span>->createToken(<span class=\"hljs-variable\">$request</span>->device_name)->plainTextToken;\n\n    <span class=\"hljs-keyword\">return</span> response()->json([<span class=\"hljs-string\">'token'</span> => <span class=\"hljs-variable\">$token</span>], <span class=\"hljs-number\">200</span>);\n}</code></pre>\n<p>Here’s a step by step breakdown of what this code does:</p>\n<ol>\n<li>We validate the incoming request.</li>\n<li>Check the outcome of this validation. If it failed, return the errors in the response.</li>\n<li>Hash the password and create the new <code>User</code>.</li>\n<li>Create a token and save it so we can return it in the response.</li>\n</ol>\n<p>As you can see, performing a successful request to this endpoint will return the generated token in the body of the response. However, to make sure our users don’t need to create a new account whenever they want to use the app on another device, let’s create the function to allow our users to request their token:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">token</span>(<span class=\"hljs-params\">Request <span class=\"hljs-variable\">$request</span></span>)\n</span>{\n    <span class=\"hljs-comment\">// 1</span>\n    <span class=\"hljs-variable\">$validator</span> = Validator::make(<span class=\"hljs-variable\">$request</span>->all(), [\n        <span class=\"hljs-string\">'email'</span> => [<span class=\"hljs-string\">'required'</span>, <span class=\"hljs-string\">'string'</span>, <span class=\"hljs-string\">'email'</span>, <span class=\"hljs-string\">'max:255'</span>],\n        <span class=\"hljs-string\">'password'</span> => [<span class=\"hljs-string\">'required'</span>, <span class=\"hljs-string\">'string'</span>, <span class=\"hljs-string\">'min:8'</span>],\n        <span class=\"hljs-string\">'device_name'</span> => [<span class=\"hljs-string\">'required'</span>, <span class=\"hljs-string\">'string'</span>]\n    ]);    \n    \n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable\">$validator</span>->fails()) {\n        <span class=\"hljs-keyword\">return</span> response()->json([<span class=\"hljs-string\">'error'</span> => <span class=\"hljs-variable\">$validator</span>->errors()], <span class=\"hljs-number\">422</span>);\n    }\n    \n    <span class=\"hljs-comment\">// 2</span>\n    <span class=\"hljs-variable\">$user</span> = User::where(<span class=\"hljs-string\">'email'</span>, <span class=\"hljs-variable\">$request</span>->email)->first();\n \n    <span class=\"hljs-comment\">// 3</span>\n    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-variable\">$user</span> || !Hash::check(<span class=\"hljs-variable\">$request</span>->password, <span class=\"hljs-variable\">$user</span>->password) {\n        <span class=\"hljs-keyword\">return</span> response()->json([<span class=\"hljs-string\">'error'</span> => <span class=\"hljs-string\">'The provided credentials are incorrect.'</span>], <span class=\"hljs-number\">422</span>);\n    }\n    \n    <span class=\"hljs-comment\">// 4</span>\n    <span class=\"hljs-keyword\">return</span> response()->json([<span class=\"hljs-string\">'token'</span> => <span class=\"hljs-variable\">$user</span>->createToken(<span class=\"hljs-variable\">$request</span>->device_name)->plainTextToken]);\n}</code></pre>\n<p>Here’s what this code does:</p>\n<ol>\n<li>We once again validate the request, and return the errors if validation fails.</li>\n<li>We get the first <code>User</code> from our database for the submitted email address. The email is unique, so at most this will return one user.</li>\n<li>If the user doesn’t exist (so the email was incorrect), or the password isn’t correct, we return an error the app can pick up.</li>\n<li>We return the generated token.</li>\n</ol>\n<p>The scaffolding of our authentication is now complete! Let’s quickly create a route that’ll allow us to get the name of the logged in user.</p>\n<p>In your <code>routes/api.php</code> file, add the following code:</p>\n<pre><code class=\"hljs language-php\">Route::middleware(<span class=\"hljs-string\">'auth:sanctum'</span>)->get(<span class=\"hljs-string\">'/name'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">Request <span class=\"hljs-variable\">$request</span></span>) </span>{\n    <span class=\"hljs-keyword\">return</span> response()->json([<span class=\"hljs-string\">'name'</span> => <span class=\"hljs-variable\">$request</span>->user()->name]);\n});</code></pre>\n<p>Here we use the <code>'auth:sanctum'</code> middleware. This will make sure the api token is present in the headers of the request, and will return an error if it isn’t. When the request works, we can use <code>$request->user()</code> to get access to the user model.</p>\n<p>There’s a lot more I’d like to write about the things we can easily do with Sanctum, but I’ll refrain from doing so to keep this article short. If you want to learn more about the possibilities, like adding <em>abilities</em> and revoking tokens, take a look at the <a href=\"https://github.com/laravel/sanctum\">documentation</a>.</p>\n<h2>Let’s authenticate</h2>\n<p>hunter2 is not a valid password with the validation rules we defined.</p>\n<p>It’s time to put our api to the test. Let’s open up Xcode and quickly whip up a login screen. After doing whatever client side validation you want to perform, pass the values from the fields in your register form to the function you’ll use to perform the HTTP request. To provide code that can be used regardless of your preferred architecture, I’ll simply show you how to construct the request to register a user. Make sure to include the <code>application/json</code> <code>Content-Type header</code>, or your requests won’t succeed.</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">var</span> request <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">URLRequest</span>(url: <span class=\"hljs-type\">URL</span>(string: <span class=\"hljs-string\">\"http://yourprojecturl.test/api/sanctum/register\"</span>)<span class=\"hljs-operator\">!</span>)\nrequest.httpMethod <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">\"POST\"</span>\nrequest.addValue(<span class=\"hljs-string\">\"application/json\"</span>, forHTTPHeaderField: <span class=\"hljs-string\">\"Content-Type\"</span>)\n<span class=\"hljs-keyword\">guard</span> <span class=\"hljs-keyword\">let</span> body <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">try?</span> jsonEncoder.encode([\n    <span class=\"hljs-string\">\"name\"</span>: name,\n    <span class=\"hljs-string\">\"password\"</span>: password,\n    <span class=\"hljs-string\">\"email\"</span>: email,\n    <span class=\"hljs-string\">\"device_name\"</span>: deviceName\n]) <span class=\"hljs-keyword\">else</span> {\n    <span class=\"hljs-keyword\">return</span>\n}\n\nrequest.httpBody <span class=\"hljs-operator\">=</span> body</code></pre>\n<p>The request to log in is very similar, we simply replace the final url endpoint with <code>/token</code> and remove the <code>name</code> from the body. A successful request to any of these endpoints will result in the following response body:</p>\n<pre><code class=\"hljs language-json\">{\n <span class=\"hljs-attr\">\"token\"</span>: <span class=\"hljs-string\">\"&#x3C;api token>\"</span>\n}</code></pre>\n<p>After your user registers their account or logs in, make sure to store this token somewhere. We’ll use it in this next request to retrieve their name from the backend:</p>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-keyword\">var</span> request <span class=\"hljs-operator\">=</span> <span class=\"hljs-type\">URLRequest</span>(url: <span class=\"hljs-type\">URL</span>(string: <span class=\"hljs-string\">\"http://yourprojecturl.test/api/name\"</span>))\nrequest.httpMethod <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">\"GET\"</span>\nrequest.addValue(<span class=\"hljs-string\">\"Bearer <span class=\"hljs-subst\">\\(apiToken)</span>\"</span>, forHTTPHeaderField: <span class=\"hljs-string\">\"Authorization\"</span>)</code></pre>\n<h2>A quick recap</h2>\n<p>Let’s briefly go over the things I explained in this article, to make sure we’re on the same page.</p>\n<ul>\n<li>We set up some scaffolding with Laravel and Sanctum to handle user authentication.</li>\n<li>We can create routes using the <code>'auth:sanctum'</code> middleware that will validate the token sent in the headers, and gives us access to the corresponding user model.</li>\n<li>We can create the requests to consume our API.</li>\n</ul>\n<h2>Next steps</h2>\n<p>As I mentioned before, this just scratches the surface of what we can do with Sanctum. You can create tokens with different abilities so some users can perform actions while others can’t. Or you can set the token to expire after a certain amount of time, so the user has to request a new one. Sanctum is still in beta, so expect things to change and new features to be added.</p>\n<p>Hopefully this article gave you some insights in how Sanctum can be a simple alternative to other authorization methods. If you’re a mobile developer and you have never worked with Laravel before, I highly recommend spending some time with it. You’ll be able to build the backend for your apps in no time.</p>\n<p>If you have any questions, the best way to reach out to me is through <a href=\"https://twitter.com/jillevd_w\">Twitter</a>. If you like reading this, please let me know if you’d like to read more about Laravel, Swift, or a combination of the two.</p>\n","ogImage":{"url":"/assets/blog/app-authentication-with-laravel-sanctum/cover.png"},"coverImage":"/assets/blog/app-authentication-with-laravel-sanctum/cover.png","darkCoverImage":"/assets/blog/app-authentication-with-laravel-sanctum/cover-dark.png"},"morePosts":[],"headerColor":"text-green-400"},"__N_SSG":true}